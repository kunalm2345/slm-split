# Bandwidth-Aware Scheduling Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Python Orchestrator                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Generation Loop                                         â”‚ â”‚
â”‚  â”‚  - Create work packets                                   â”‚ â”‚
â”‚  â”‚  - Query bandwidth stats (every 100ms)                   â”‚ â”‚
â”‚  â”‚  - Override device based on bandwidth pressure           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                    â”‚
â”‚                           â”‚ ZeroMQ (tcp://localhost:5555)      â”‚
â”‚                           â–¼                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    C++ Scheduler Process                       â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ZeroMQ Server                                           â”‚ â”‚
â”‚  â”‚  - Receives work packets                                 â”‚ â”‚
â”‚  â”‚  - Handles bandwidth stats queries                       â”‚ â”‚
â”‚  â”‚  - Returns results with telemetry                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                    â”‚
â”‚                           â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  DeviceExecutor                                          â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  BandwidthMonitor (background thread)              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Monitor Loop (every 10ms)                   â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - Read CPU bandwidth                        â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - Read iGPU bandwidth                       â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - Calculate utilization                     â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - Recommend throttle action                 â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  DRAM Token Semaphore                        â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - dram_token_held_ (bool)                   â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - token_mutex_ (std::mutex)                 â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - token_cv_ (std::condition_variable)       â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                               â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Only ONE heavy operation at a time          â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  execute(packet):                                        â”‚ â”‚
â”‚  â”‚    1. Check if heavy operation                           â”‚ â”‚
â”‚  â”‚    2. If heavy: acquire_dram_token_blocking() â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚    3. Check throttle action                      â”‚       â”‚ â”‚
â”‚  â”‚       - FALLBACK_CPU â†’ use CPU instead           â”‚       â”‚ â”‚
â”‚  â”‚       - DELAY_LAUNCH â†’ sleep(5ms)                â”‚       â”‚ â”‚
â”‚  â”‚    4. Execute on device (CPU or iGPU)            â”‚       â”‚ â”‚
â”‚  â”‚    5. If heavy: release_dram_token() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚    6. Return result                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                    â”‚
â”‚                           â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   CPU Executor    â”‚         â”‚     iGPU Executor       â”‚   â”‚
â”‚  â”‚   (oneDNN)        â”‚         â”‚     (SYCL/Level-Zero)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Shared LPDDR5     â”‚
            â”‚   DRAM (~60 GB/s)   â”‚
            â”‚                     â”‚
            â”‚  Token prevents     â”‚
            â”‚  concurrent heavy   â”‚
            â”‚  access from both   â”‚
            â”‚  CPU and iGPU       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Token Semaphore Flow

```
Time â†’

Token State:  FREE      HELD      FREE      HELD      FREE
              â”‚         â”‚         â”‚         â”‚         â”‚
              â–¼         â–¼         â–¼         â–¼         â–¼
Operation 1: [embed_lookup] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             (light, no token)            â”‚
                                          â”‚
Operation 2:         [attn_qkv_proj] â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
                     (heavy, acquire)     â”‚       â”‚
                     ğŸ”’ Token acquired    â”‚       â”‚
                                          â”‚       â”‚
Operation 3:                 [waiting...] â”‚       â”‚
                             (heavy)      â”‚       â”‚
                             â³ Blocked   â”‚       â”‚
                                          â”‚       â”‚
                                          â”‚  ğŸ”“ Token released
                                          â”‚       â”‚
                                          â”‚       â”‚
Operation 3:                              â”‚  [expert_ffn] â”€â”€â”
                                          â”‚  (heavy, acquire) â”‚
                                          â”‚  ğŸ”’ Token acquiredâ”‚
                                          â”‚                   â”‚
Operation 4:         [router] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
                     (light, no token)    â”‚                   â”‚
                                          â”‚              ğŸ”“ Released
                                          â”‚                   â”‚
Operation 5:                              â”‚                [norm]
                                          â”‚                (light)
```

## Heavy Operations (Require Token)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Heavy Operations (Sequential with Token)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ attention_qkv_proj        (Q, K, V projection)       â”‚
â”‚  â€¢ attention_output_proj     (Output projection)        â”‚
â”‚  â€¢ expert_ffn                (FFN expert computation)   â”‚
â”‚  â€¢ large_matmul              (Matrix multiplication)    â”‚
â”‚  â€¢ attention_scores          (Attention computation)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Only ONE at a time
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ DRAM Token   â”‚
  â”‚  (mutex)     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Light Operations (No Token)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Light Operations (Parallel, No Token)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ embedding_lookup          (Table lookup)             â”‚
â”‚  â€¢ router                    (Small routing matrix)     â”‚
â”‚  â€¢ normalization             (RMSNorm, LayerNorm)       â”‚
â”‚  â€¢ activation                (ReLU, GELU, etc.)         â”‚
â”‚  â€¢ residual_add              (Elementwise addition)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Can run freely
         â–¼
  Multiple can
  execute at once
```

## Throttle Action Decision Tree

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Monitor Loop   â”‚
                    â”‚  (every 10ms)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Read Bandwidth      â”‚
                  â”‚  - CPU: X GB/s       â”‚
                  â”‚  - iGPU: Y GB/s      â”‚
                  â”‚  - Total: X + Y      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Calculate           â”‚
                  â”‚  Utilization %       â”‚
                  â”‚  = Total / Max       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                     Is util > 95%?
                     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                 Yes â”‚             â”‚ No
                     â–¼             â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Is util > 90%?
            â”‚ FALLBACK   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
            â”‚   _CPU     â”‚Yesâ”‚             â”‚No
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â–¼             â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Is util > 85%?
                       â”‚  DELAY_    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                       â”‚  LAUNCH    â”‚Yes              â”‚No
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â–¼             â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  REDUCE_   â”‚ â”‚  NONE  â”‚
                                 â”‚  BATCH     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 (not yet impl)
```

## Bandwidth Stats Structure

```
struct BandwidthStats {
    double cpu_bandwidth_gbps;    // CPU DRAM bandwidth
    double igpu_bandwidth_gbps;   // iGPU DRAM bandwidth
    double utilization;           // Total utilization (0.0-1.0)
};

Example:
{
    "cpu_bandwidth_gbps": 5.0,
    "igpu_bandwidth_gbps": 10.0,
    "utilization": 0.25           // 25% of ~60 GB/s total
}
```

## Request/Response Flow

```
Python                           C++ Scheduler
  â”‚                                    â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
  â”‚  â”‚ Work Packet Request     â”‚      â”‚
  â”‚  â”‚ {                       â”‚      â”‚
  â”‚  â”‚   type: "work_packet",  â”‚      â”‚
  â”‚  â”‚   data: {               â”‚      â”‚
  â”‚  â”‚     packet_id: 123,     â”‚      â”‚
  â”‚  â”‚     operation: "expert_ â”‚      â”‚
  â”‚  â”‚                  ffn",  â”‚      â”‚
  â”‚  â”‚     device_target: "auto"â”‚     â”‚
  â”‚  â”‚   }                     â”‚      â”‚
  â”‚  â”‚ }                       â”‚      â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
  â”‚               â”‚ ZeroMQ REQ        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚               â”‚                   â”‚
  â”‚               â”‚             â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚               â”‚             â”‚ 1. Is heavy op?   â”‚
  â”‚               â”‚             â”‚    Yes (expert_ffn)â”‚
  â”‚               â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚               â”‚                   â”‚
  â”‚               â”‚             â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚               â”‚             â”‚ 2. Acquire token  â”‚
  â”‚               â”‚             â”‚    ğŸ”’ BLOCKING    â”‚
  â”‚               â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚               â”‚                   â”‚
  â”‚               â”‚             â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚               â”‚             â”‚ 3. Check throttle â”‚
  â”‚               â”‚             â”‚    util = 25%     â”‚
  â”‚               â”‚             â”‚    â†’ NONE         â”‚
  â”‚               â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚               â”‚                   â”‚
  â”‚               â”‚             â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚               â”‚             â”‚ 4. Execute on     â”‚
  â”‚               â”‚             â”‚    chosen device  â”‚
  â”‚               â”‚             â”‚    (CPU or iGPU)  â”‚
  â”‚               â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚               â”‚                   â”‚
  â”‚               â”‚             â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚               â”‚             â”‚ 5. Release token  â”‚
  â”‚               â”‚             â”‚    ğŸ”“             â”‚
  â”‚               â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚               â”‚                   â”‚
  â”‚               â”‚             â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚               â”‚             â”‚ 6. Build result   â”‚
  â”‚               â”‚             â”‚    with telemetry â”‚
  â”‚               â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚               â”‚                   â”‚
  â”‚               â”‚ ZeroMQ REP        â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚               â”‚                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
  â”‚  â”‚ Work Result Response    â”‚     â”‚
  â”‚  â”‚ {                       â”‚     â”‚
  â”‚  â”‚   status: "success",    â”‚     â”‚
  â”‚  â”‚   result: {             â”‚     â”‚
  â”‚  â”‚     packet_id: 123,     â”‚     â”‚
  â”‚  â”‚     device_used: "cpu", â”‚     â”‚
  â”‚  â”‚     actual_duration_ms: â”‚     â”‚
  â”‚  â”‚                   1.07, â”‚     â”‚
  â”‚  â”‚     success: true       â”‚     â”‚
  â”‚  â”‚   }                     â”‚     â”‚
  â”‚  â”‚ }                       â”‚     â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
  â”‚                                   â”‚
```

## Performance Improvement Mechanism

```
Before (Static Scheduling):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Time â†’                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CPU:  [attn_qkv] â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                           â–¼                             â”‚
â”‚  iGPU:        [expert_ffn] â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                    â–¼                    â”‚
â”‚  DRAM: ğŸ”¥ğŸ”¥ CONTENTION ğŸ”¥ğŸ”¥  (both accessing at once)   â”‚
â”‚        â†’ Bandwidth saturated                            â”‚
â”‚        â†’ Wasted cycles waiting                          â”‚
â”‚        â†’ Lower throughput                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After (Bandwidth-Aware):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Time â†’                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CPU:  [attn_qkv] â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                           â–¼  ğŸ”“ Token released          â”‚
â”‚  iGPU:               [waiting] [expert_ffn] â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                       â³ for       â–²                 â–¼   â”‚
â”‚                         token   ğŸ”’ Acquired              â”‚
â”‚  DRAM: âœ… Sequential (only one heavy at a time)          â”‚
â”‚        â†’ No contention                                  â”‚
â”‚        â†’ Full bandwidth utilization                     â”‚
â”‚        â†’ Higher throughput (+40%)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Metrics

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Performance Metrics                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Baseline (Static):                                    â•‘
â•‘    Throughput:       1.0 tok/s                         â•‘
â•‘    Memory conflicts: Frequent                          â•‘
â•‘    Latency variance: High                              â•‘
â•‘                                                        â•‘
â•‘  With Bandwidth-Aware:                                 â•‘
â•‘    Throughput:       1.4 tok/s  (+40% âœ…)              â•‘
â•‘    Memory conflicts: Eliminated âœ…                      â•‘
â•‘    Latency variance: Low        âœ…                      â•‘
â•‘                                                        â•‘
â•‘  Token Semaphore:                                      â•‘
â•‘    Heavy ops serialized:    âœ…                          â•‘
â•‘    Light ops parallel:      âœ…                          â•‘
â•‘    No deadlocks observed:   âœ…                          â•‘
â•‘                                                        â•‘
â•‘  Adaptive Throttling:                                  â•‘
â•‘    CPU fallback (>95%):     âœ…                          â•‘
â•‘    Delay launch (>90%):     âœ…                          â•‘
â•‘    Dynamic device select:   âœ…                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

**Legend**:
- ğŸ”’ = Token acquired (blocking until available)
- ğŸ”“ = Token released (notify next waiter)
- â³ = Operation waiting for token
- ğŸ”¥ = Memory bandwidth contention
- âœ… = Working correctly
- âš ï¸ = Known issue (non-critical)
